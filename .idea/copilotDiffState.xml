<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/api/models.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/api/models.py" />
              <option name="originalContent" value="from enum import Enum&#10;from typing import List&#10;&#10;from sqlalchemy import Column, Integer, String, Boolean, Text, TIMESTAMP, ForeignKey, UniqueConstraint, func, VARCHAR, Table&#10;from sqlalchemy.orm import DeclarativeBase, Mapped, relationship&#10;from sqlalchemy import Enum as SQLEnum, exists, and_&#10;from sqlalchemy.ext.hybrid import hybrid_property&#10;&#10;&#10;class Base(DeclarativeBase):&#10;    pass&#10;&#10;&#10;class Group(Base):&#10;    __tablename__ = 'groups'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    name = Column(VARCHAR(32), unique=True, nullable=False)&#10;    point_of_contact = Column(String(50))&#10;    unix_gid = Column(Integer, unique=True)&#10;    has_groupdir = Column(Boolean, nullable=False, default=True)&#10;&#10;&#10;class Note(Base):&#10;    __tablename__ = 'notes'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    ticket = Column(String(9))&#10;    note = Column(Text)&#10;    author = Column(String(255))&#10;    date = Column(TIMESTAMP, nullable=False, server_default=func.now())&#10;&#10;    # Relationships&#10;    users: Mapped[List[&quot;User&quot;]] = relationship(&#10;        secondary=&quot;user_notes&quot;,&#10;        primaryjoin=&quot;Note.id==UserNote.note_id&quot;,&#10;        secondaryjoin=&quot;User.id==UserNote.user_id&quot;,&#10;        foreign_keys=&quot;[UserNote.note_id, UserNote.user_id]&quot;,&#10;        lazy=&quot;joined&quot;,&#10;        back_populates=&quot;notes&quot;&#10;    )&#10;&#10;&#10;class Project(Base):&#10;    __tablename__ = 'projects'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    name = Column(String(255), nullable=False, unique=True)&#10;    pi = Column(Integer)&#10;    staff1 = Column(String(255))&#10;    staff2 = Column(String(255))&#10;    status = Column(String(255))&#10;    access = Column(String(255))&#10;    accounting_group = Column(String(255), nullable=False)&#10;    url = Column(String(255))&#10;    date = Column(TIMESTAMP, nullable=False, server_default=func.now())&#10;    ticket = Column(Integer)&#10;    last_contact = Column(TIMESTAMP)&#10;&#10;&#10;class SubmitNode(Base):&#10;    __tablename__ = 'submit_nodes'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    name = Column(String(60))&#10;&#10;&#10;class RoleEnum(Enum):&#10;    MEMBER = &quot;MEMBER&quot;&#10;    PI = &quot;PI&quot;&#10;&#10;class PositionEnum(Enum):&#10;    SELECT = &quot;SELECT&quot;&#10;    FACULTY = &quot;FACULTY&quot;&#10;    STAFF = &quot;STAFF&quot;&#10;    POSTDOC = &quot;POSTDOC&quot;&#10;    GRAD_STUDENT = &quot;GRAD_STUDENT&quot;&#10;    UNDERGRADUATE = &quot;UNDERGRADUATE&quot;&#10;    OTHER = &quot;OTHER&quot;&#10;&#10;&#10;class User(Base):&#10;    __tablename__ = 'users'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    username = Column(String(255))&#10;    name = Column(String(255))&#10;    password = Column(String(255))&#10;    email1 = Column(String(255))&#10;    email2 = Column(String(255))&#10;    netid = Column(String(255))&#10;    netid_exp_datetime = Column(TIMESTAMP)&#10;    phone1 = Column(String(255))&#10;    phone2 = Column(String(255))&#10;    is_admin = Column(Boolean)&#10;    auth_netid = Column(Boolean)&#10;    auth_username = Column(Boolean)&#10;    date = Column(TIMESTAMP, nullable=False)&#10;    unix_uid = Column(Integer)&#10;    position = Column(SQLEnum(PositionEnum, name=&quot;position_enum&quot;), nullable=True)&#10;&#10;    notes: Mapped[List[&quot;Note&quot;]] = relationship(&#10;        secondary=&quot;user_notes&quot;,&#10;        primaryjoin=&quot;User.id==UserNote.user_id&quot;,&#10;        secondaryjoin=&quot;Note.id==UserNote.note_id&quot;,&#10;        foreign_keys=&quot;[UserNote.user_id, UserNote.note_id]&quot;,&#10;        lazy=&quot;joined&quot;,&#10;        back_populates=&quot;users&quot;&#10;    )&#10;&#10;&#10;class UserGroup(Base):&#10;    __tablename__ = 'user_groups'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    group_id = Column(Integer, ForeignKey('groups.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    __table_args__ = (UniqueConstraint('user_id', 'group_id', name='user_groups_distinct'),)&#10;&#10;&#10;class UserNote(Base):&#10;    __tablename__ = 'user_notes'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    project_id = Column(Integer, ForeignKey('notes.id', ondelete=&quot;CASCADE&quot;))&#10;    note_id = Column(Integer, ForeignKey('notes.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;))&#10;&#10;&#10;class UserProject(Base):&#10;    __tablename__ = 'user_projects'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    project_id = Column(Integer, ForeignKey('projects.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    role = Column(SQLEnum(RoleEnum, name=&quot;role_enum&quot;), nullable=True)&#10;    is_primary = Column(Boolean, nullable=False, default=False)&#10;    __table_args__ = (UniqueConstraint('user_id', 'project_id', name='user_projects_distinct'),)&#10;&#10;&#10;class UserSubmit(Base):&#10;    __tablename__ = 'user_submits'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    submit_node_id = Column(Integer, ForeignKey('submit_nodes.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    for_auth_netid = Column(Boolean)&#10;    disk_quota = Column(Integer)&#10;    hpc_diskquota = Column(Integer, nullable=False, default=100)&#10;    hpc_inodequota = Column(Integer, nullable=False, default=50000)&#10;    hpc_joblimit = Column(Integer, nullable=False, default=10)&#10;    hpc_corelimit = Column(Integer, nullable=False, default=720)&#10;    hpc_fairshare = Column(Integer, nullable=False, default=100)&#10;    __table_args__ = (UniqueConstraint('user_id', 'submit_node_id', name='user_submits_distinct'),)&#10;&#10;&#10;class PiProjectView(Base):&#10;    __tablename__ = 'pi_projects'&#10;    user_id = Column(Integer, primary_key=True)&#10;    username = Column(String(255))&#10;    name = Column(String(255))&#10;    project_id = Column(Integer, primary_key=True)&#10;    project_name = Column(String(255))&#10;&#10;&#10;class FullProjectView(Base):&#10;    __tablename__ = 'full_projects'&#10;    id = Column(Integer, primary_key=True)&#10;    name = Column(String(255))&#10;    pi = Column(Integer)&#10;    staff1 = Column(String(255))&#10;    staff2 = Column(String(255))&#10;    status = Column(String(255))&#10;    access = Column(String(255))&#10;    accounting_group = Column(String(255))&#10;    url = Column(String(255))&#10;    date = Column(TIMESTAMP)&#10;    ticket = Column(Integer)&#10;    last_contact = Column(TIMESTAMP)&#10;    user_id = Column(Integer)&#10;    username = Column(String(255))&#10;    user_name = Column(String(255))&#10;    role = Column(SQLEnum(RoleEnum, name=&quot;role_enum&quot;))&#10;    is_primary = Column(Boolean)&#10;&#10;&#10;class JoinedProjectView(Base):&#10;    __tablename__ = 'joined_projects'&#10;    user_id = Column(Integer, primary_key=True)&#10;    username = Column(String(255))&#10;    email1 = Column(String(255))&#10;    phone1 = Column(String(255))&#10;    netid = Column(String(255))&#10;    user_name = Column(String(255))&#10;    project_id = Column(Integer, primary_key=True)&#10;    project_name = Column(String(255))&#10;    role = Column(SQLEnum(RoleEnum, name=&quot;role_enum&quot;))&#10;" />
              <option name="updatedContent" value="from enum import Enum&#10;from typing import List&#10;&#10;from sqlalchemy import Column, Integer, String, Boolean, Text, TIMESTAMP, ForeignKey, UniqueConstraint, func, VARCHAR, Table&#10;from sqlalchemy.orm import DeclarativeBase, Mapped, relationship&#10;from sqlalchemy import Enum as SQLEnum, exists, and_&#10;from sqlalchemy.ext.hybrid import hybrid_property&#10;&#10;&#10;class Base(DeclarativeBase):&#10;    pass&#10;&#10;&#10;class Group(Base):&#10;    __tablename__ = 'groups'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    name = Column(VARCHAR(32), unique=True, nullable=False)&#10;    point_of_contact = Column(String(50))&#10;    unix_gid = Column(Integer, unique=True)&#10;    has_groupdir = Column(Boolean, nullable=False, default=True)&#10;&#10;&#10;class Note(Base):&#10;    __tablename__ = 'notes'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    ticket = Column(String(9))&#10;    note = Column(Text)&#10;    author = Column(String(255))&#10;    date = Column(TIMESTAMP, nullable=False, server_default=func.now())&#10;&#10;    # Relationships&#10;    users: Mapped[List[&quot;User&quot;]] = relationship(&#10;        secondary=&quot;user_notes&quot;,&#10;        primaryjoin=&quot;Note.id==UserNote.note_id&quot;,&#10;        secondaryjoin=&quot;User.id==UserNote.user_id&quot;,&#10;        foreign_keys=&quot;[UserNote.note_id, UserNote.user_id]&quot;,&#10;        lazy=&quot;joined&quot;,&#10;        back_populates=&quot;notes&quot;&#10;    )&#10;&#10;&#10;class Project(Base):&#10;    __tablename__ = 'projects'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    name = Column(String(255), nullable=False, unique=True)&#10;    pi = Column(Integer)&#10;    staff1 = Column(String(255))&#10;    staff2 = Column(String(255))&#10;    status = Column(String(255))&#10;    access = Column(String(255))&#10;    accounting_group = Column(String(255), nullable=False)&#10;    url = Column(String(255))&#10;    date = Column(TIMESTAMP, nullable=False, server_default=func.now())&#10;    ticket = Column(Integer)&#10;    last_contact = Column(TIMESTAMP)&#10;&#10;&#10;class SubmitNode(Base):&#10;    __tablename__ = 'submit_nodes'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    name = Column(String(60))&#10;&#10;&#10;class RoleEnum(Enum):&#10;    MEMBER = &quot;MEMBER&quot;&#10;    PI = &quot;PI&quot;&#10;&#10;class PositionEnum(Enum):&#10;    SELECT = &quot;SELECT&quot;&#10;    FACULTY = &quot;FACULTY&quot;&#10;    STAFF = &quot;STAFF&quot;&#10;    POSTDOC = &quot;POSTDOC&quot;&#10;    GRAD_STUDENT = &quot;GRAD_STUDENT&quot;&#10;    UNDERGRADUATE = &quot;UNDERGRADUATE&quot;&#10;    OTHER = &quot;OTHER&quot;&#10;&#10;&#10;class User(Base):&#10;    __tablename__ = 'users'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    username = Column(String(255))&#10;    name = Column(String(255))&#10;    password = Column(String(255))&#10;    email1 = Column(String(255))&#10;    email2 = Column(String(255))&#10;    netid = Column(String(255))&#10;    netid_exp_datetime = Column(TIMESTAMP)&#10;    phone1 = Column(String(255))&#10;    phone2 = Column(String(255))&#10;    is_admin = Column(Boolean)&#10;    auth_netid = Column(Boolean)&#10;    auth_username = Column(Boolean)&#10;    date = Column(TIMESTAMP, nullable=False)&#10;    unix_uid = Column(Integer)&#10;    position = Column(SQLEnum(PositionEnum, name=&quot;position_enum&quot;), nullable=True)&#10;&#10;    notes: Mapped[List[&quot;Note&quot;]] = relationship(&#10;        secondary=&quot;user_notes&quot;,&#10;        primaryjoin=&quot;User.id==UserNote.user_id&quot;,&#10;        secondaryjoin=&quot;Note.id==UserNote.note_id&quot;,&#10;        foreign_keys=&quot;[UserNote.user_id, UserNote.note_id]&quot;,&#10;        lazy=&quot;joined&quot;,&#10;        back_populates=&quot;users&quot;&#10;    )&#10;&#10;&#10;class UserGroup(Base):&#10;    __tablename__ = 'user_groups'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    group_id = Column(Integer, ForeignKey('groups.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    __table_args__ = (UniqueConstraint('user_id', 'group_id', name='user_groups_distinct'),)&#10;&#10;&#10;class UserNote(Base):&#10;    __tablename__ = 'user_notes'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    project_id = Column(Integer, ForeignKey('notes.id', ondelete=&quot;CASCADE&quot;))&#10;    note_id = Column(Integer, ForeignKey('notes.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;))&#10;&#10;&#10;class UserProject(Base):&#10;    __tablename__ = 'user_projects'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    project_id = Column(Integer, ForeignKey('projects.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    role = Column(SQLEnum(RoleEnum, name=&quot;role_enum&quot;), nullable=True)&#10;    is_primary = Column(Boolean, nullable=False, default=False)&#10;    __table_args__ = (UniqueConstraint('user_id', 'project_id', name='user_projects_distinct'),)&#10;&#10;&#10;class UserSubmit(Base):&#10;    __tablename__ = 'user_submits'&#10;    id = Column(Integer, primary_key=True, index=True)&#10;    user_id = Column(Integer, ForeignKey('users.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    submit_node_id = Column(Integer, ForeignKey('submit_nodes.id', ondelete=&quot;CASCADE&quot;), nullable=False)&#10;    for_auth_netid = Column(Boolean)&#10;    disk_quota = Column(Integer)&#10;    hpc_diskquota = Column(Integer, nullable=False, default=100)&#10;    hpc_inodequota = Column(Integer, nullable=False, default=50000)&#10;    hpc_joblimit = Column(Integer, nullable=False, default=10)&#10;    hpc_corelimit = Column(Integer, nullable=False, default=720)&#10;    hpc_fairshare = Column(Integer, nullable=False, default=100)&#10;    __table_args__ = (UniqueConstraint('user_id', 'submit_node_id', name='user_submits_distinct'),)&#10;&#10;&#10;class PiProjectView(Base):&#10;    __tablename__ = 'pi_projects'&#10;    user_id = Column(Integer, primary_key=True)&#10;    username = Column(String(255))&#10;    name = Column(String(255))&#10;    project_id = Column(Integer, primary_key=True)&#10;    project_name = Column(String(255))&#10;&#10;&#10;class FullProjectView(Base):&#10;    __tablename__ = 'full_projects'&#10;    id = Column(Integer, primary_key=True)&#10;    name = Column(String(255))&#10;    pi = Column(Integer)&#10;    staff1 = Column(String(255))&#10;    staff2 = Column(String(255))&#10;    status = Column(String(255))&#10;    access = Column(String(255))&#10;    accounting_group = Column(String(255))&#10;    url = Column(String(255))&#10;    date = Column(TIMESTAMP)&#10;    ticket = Column(Integer)&#10;    last_contact = Column(TIMESTAMP)&#10;    user_id = Column(Integer)&#10;    username = Column(String(255))&#10;    user_name = Column(String(255))&#10;    role = Column(SQLEnum(RoleEnum, name=&quot;role_enum&quot;))&#10;    is_primary = Column(Boolean)&#10;&#10;&#10;class JoinedProjectView(Base):&#10;    __tablename__ = 'joined_projects'&#10;    user_id = Column(Integer, primary_key=True)&#10;    username = Column(String(255))&#10;    email1 = Column(String(255))&#10;    phone1 = Column(String(255))&#10;    netid = Column(String(255))&#10;    user_name = Column(String(255))&#10;    project_id = Column(Integer, primary_key=True)&#10;    project_name = Column(String(255))&#10;    role = Column(SQLEnum(RoleEnum, name=&quot;role_enum&quot;))" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/api/routes/projects.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/api/routes/projects.py" />
              <option name="originalContent" value="from fastapi import APIRouter, Response, Depends, HTTPException&#10;from sqlalchemy import delete, select&#10;&#10;from api.query_parser import get_filter_query_params&#10;from api.util import list_endpoint, get_one_endpoint, create_one_endpoint, update_one_endpoint, delete_one_endpoint, \&#10;    list_select_stmt&#10;from api import models as m&#10;from api import schemas as s&#10;from api.db import get_async_session, session_generator&#10;&#10;router = APIRouter(&#10;    prefix=&quot;/projects&quot;,&#10;    responses={&#10;        404: {&#10;            &quot;description&quot;: &quot;Not found&quot;&#10;        }&#10;    }&#10;)&#10;&#10;@router.get(&quot;&quot;)&#10;async def get_projects(response: Response, page: int = 0, page_size: int = 100, filter_query_params=Depends(get_filter_query_params), session=Depends(session_generator)) -&gt; list[s.Project]:&#10;    return await list_endpoint(session, m.Project, s.Project, response, filter_query_params, page, page_size)&#10;&#10;&#10;@router.delete(&quot;/{project_id}&quot;, status_code=204)&#10;async def delete_project(project_id: int, session=Depends(session_generator)) -&gt; None:&#10;    &quot;&quot;&quot;Delete a project by ID&quot;&quot;&quot;&#10;&#10;    await delete_one_endpoint(session, m.Project, project_id)&#10;&#10;    await session.execute(&#10;        delete(m.Note)&#10;        .where(&#10;            m.Note.id.in_(&#10;                select(m.UserNote.note_id)&#10;                .where(m.UserNote.project_id == project_id)&#10;            )&#10;        )&#10;    )&#10;&#10;&#10;@router.get(&quot;/{project_id}&quot;)&#10;async def get_project(project_id: int, session=Depends(session_generator)) -&gt; s.Project:&#10;    return await get_one_endpoint(session, m.Project, s.Project, project_id)&#10;&#10;&#10;@router.post(&quot;&quot;, status_code=201)&#10;async def create_project(project: s.ProjectCreate, session=Depends(session_generator)) -&gt; s.Project:&#10;    return await create_one_endpoint(session, m.Project, s.Project, project)&#10;&#10;&#10;@router.put(&quot;/{project_id}&quot;, status_code=200)&#10;async def update_project(project_id: int, project: s.ProjectUpdate, session=Depends(session_generator)) -&gt; s.Project:&#10;    return await update_one_endpoint(session, m.Project, s.Project, project_id, project)&#10;&#10;&#10;@router.post(&quot;/{project_id}/user&quot;, status_code=201)&#10;async def add_user_to_project(project_id: int, user_project: s.UserProjectCreate, session=Depends(session_generator)) -&gt; dict:&#10;    &quot;&quot;&quot;Add user to a project&quot;&quot;&quot;&#10;&#10;    # Check if the user exists&#10;    existing_user = await session.get(m.User, user_project.user_id)&#10;    if existing_user is None:&#10;        raise HTTPException(status_code=404, detail=f&quot;User with id ({user_project.user_id}) not found&quot;)&#10;&#10;    # Create the mapping&#10;    project_user = m.UserProject(*user_project)&#10;    session.add(project_user)&#10;&#10;    return {&quot;message&quot;: f&quot;User {user_project.id} added to project {project_id}&quot;}&#10;&#10;&#10;@router.delete(&quot;/{project_id}/user/{user_id}&quot;, status_code=204)&#10;async def remove_user_from_project(project_id: int, user_id: int, session=Depends(session_generator)) -&gt; None:&#10;    &quot;&quot;&quot;Remove user from a project&quot;&quot;&quot;&#10;&#10;    result = await session.execute(&#10;        delete(m.UserProject)&#10;        .where(&#10;            m.UserProject.project_id == project_id,&#10;            m.UserProject.user_id == user_id&#10;        )&#10;    )&#10;&#10;    if result.rowcount == 0:&#10;        raise HTTPException(status_code=404, detail=&quot;User not found in project&quot;)&#10;&#10;&#10;@router.post(&quot;/{project_id}/notes&quot;, status_code=201)&#10;async def get_project_notes(project_id: int, response: Response, page: int = 0, page_size: int = 100, filter_query_params=Depends(get_filter_query_params), session=Depends(session_generator)) -&gt; list[s.Note]:&#10;    &quot;&quot;&quot;Get notes associated with a project&quot;&quot;&quot;&#10;&#10;    select_stmt = select(*m.Note.__table__.columns).join(&#10;        m.UserNote, m.Note.id == m.UserNote.note_id&#10;    ).where(m.UserNote.project_id == project_id)&#10;    return await list_select_stmt(session, select_stmt, m.Note, s.Note, response, filter_query_params, page, page_size)&#10;&#10;&#10;@router.post(&quot;/{project_id}/notes&quot;, status_code=201)&#10;async def add_note_to_project(project_id: int, note: s.NoteCreate, session=Depends(session_generator)) -&gt; s.Note:&#10;    &quot;&quot;&quot;Add a note to a project&quot;&quot;&quot;&#10;&#10;    note_schema_only = s.NoteBase(**note.model_dump(exclude={'users'}))&#10;    new_note = await create_one_endpoint(session, m.Note, s.Note, note_schema_only)&#10;&#10;    # Add the mapping to the project&#10;    project_note = m.UserNote(&#10;        project_id=project_id,&#10;        note_id=new_note.id&#10;    )&#10;    session.add(project_note)&#10;&#10;    # Add the users associated with the note&#10;    for user_id in note.users:&#10;        user_note = m.UserNote(&#10;            project_id=project_id,&#10;            user_id=user_id,&#10;            note_id=new_note.id&#10;        )&#10;        session.add(user_note)&#10;&#10;    await session.refresh(new_note)&#10;&#10;    return new_note&#10;&#10;&#10;@router.delete(&quot;/{project_id}/notes/{note_id}&quot;, status_code=204)&#10;async def delete_note_from_project(project_id: int, note_id: int, session=Depends(session_generator)):&#10;    &quot;&quot;&quot;Delete a note from a project&quot;&quot;&quot;&#10;&#10;    await session.execute(&#10;        delete(m.ProjectNote)&#10;        .where(&#10;            m.ProjectNote.project_id == project_id,&#10;            m.ProjectNote.note_id == note_id&#10;        )&#10;    )&#10;&#10;&#10;@router.delete(&quot;/{project_id}/user/{user_id}&quot;, status_code=204)&#10;async def delete_user_from_project(project_id: int, user_id: int, session=Depends(session_generator)):&#10;    &quot;&quot;&quot;Delete a user from a project&quot;&quot;&quot;&#10;&#10;    # Delete the user to project mapping&#10;    await session.execute(&#10;        delete(m.UserProject)&#10;        .where(&#10;            m.UserProject.project_id == project_id,&#10;            m.UserProject.user_id == user_id&#10;        )&#10;    )&#10;&#10;    # Delete any notes associated with the user for the project&#10;    await session.execute(&#10;        delete(m.UserNote)&#10;        .where(&#10;            m.UserNote.project_id == project_id,&#10;            m.UserNote.user_id == user_id&#10;        )&#10;    )&#10;&#10;    # Delete any orphaned notes for the project (notes without any associated users)&#10;    await session.execute(&#10;        delete(m.Note)&#10;        .where(&#10;            m.Note.id.in_(&#10;                select(m.Note.id)&#10;                .join(m.UserNote, isouter=True)&#10;                .where(&#10;                    m.UserNote.project_id == project_id,&#10;                    m.UserNote.user_id == None&#10;                )&#10;            )&#10;        )&#10;    )&#10;" />
              <option name="updatedContent" value="from fastapi import APIRouter, Response, Depends, HTTPException&#10;from sqlalchemy import delete, select&#10;&#10;from api.query_parser import get_filter_query_params&#10;from api.util import list_endpoint, get_one_endpoint, create_one_endpoint, update_one_endpoint, delete_one_endpoint, \&#10;    list_select_stmt&#10;from api import models as m&#10;from api import schemas as s&#10;from api.db import get_async_session, session_generator&#10;&#10;router = APIRouter(&#10;    prefix=&quot;/projects&quot;,&#10;    responses={&#10;        404: {&#10;            &quot;description&quot;: &quot;Not found&quot;&#10;        }&#10;    }&#10;)&#10;&#10;@router.get(&quot;&quot;)&#10;async def get_projects(response: Response, page: int = 0, page_size: int = 100, filter_query_params=Depends(get_filter_query_params), session=Depends(session_generator)) -&gt; list[s.Project]:&#10;    return await list_endpoint(session, m.Project, s.Project, response, filter_query_params, page, page_size)&#10;&#10;&#10;@router.delete(&quot;/{project_id}&quot;, status_code=204)&#10;async def delete_project(project_id: int, session=Depends(session_generator)) -&gt; None:&#10;    &quot;&quot;&quot;Delete a project by ID&quot;&quot;&quot;&#10;&#10;    await delete_one_endpoint(session, m.Project, project_id)&#10;&#10;    await session.execute(&#10;        delete(m.Note)&#10;        .where(&#10;            m.Note.id.in_(&#10;                select(m.UserNote.note_id)&#10;                .where(m.UserNote.project_id == project_id)&#10;            )&#10;        )&#10;    )&#10;&#10;&#10;@router.get(&quot;/{project_id}&quot;)&#10;async def get_project(project_id: int, session=Depends(session_generator)) -&gt; s.Project:&#10;    return await get_one_endpoint(session, m.Project, s.Project, project_id)&#10;&#10;&#10;@router.post(&quot;&quot;, status_code=201)&#10;async def create_project(project: s.ProjectCreate, session=Depends(session_generator)) -&gt; s.Project:&#10;    return await create_one_endpoint(session, m.Project, s.Project, project)&#10;&#10;&#10;@router.put(&quot;/{project_id}&quot;, status_code=200)&#10;async def update_project(project_id: int, project: s.ProjectUpdate, session=Depends(session_generator)) -&gt; s.Project:&#10;    return await update_one_endpoint(session, m.Project, s.Project, project_id, project)&#10;&#10;&#10;@router.post(&quot;/{project_id}/user&quot;, status_code=201)&#10;async def add_user_to_project(project_id: int, user_project: s.UserProjectCreate, session=Depends(session_generator)) -&gt; dict:&#10;    &quot;&quot;&quot;Add user to a project&quot;&quot;&quot;&#10;&#10;    # Check if the user exists&#10;    existing_user = await session.get(m.User, user_project.user_id)&#10;    if existing_user is None:&#10;        raise HTTPException(status_code=404, detail=f&quot;User with id ({user_project.user_id}) not found&quot;)&#10;&#10;    # Create the mapping&#10;    project_user = m.UserProject(*user_project)&#10;    session.add(project_user)&#10;&#10;    return {&quot;message&quot;: f&quot;User {user_project.id} added to project {project_id}&quot;}&#10;&#10;&#10;@router.delete(&quot;/{project_id}/user/{user_id}&quot;, status_code=204)&#10;async def remove_user_from_project(project_id: int, user_id: int, session=Depends(session_generator)) -&gt; None:&#10;    &quot;&quot;&quot;Remove user from a project&quot;&quot;&quot;&#10;&#10;    result = await session.execute(&#10;        delete(m.UserProject)&#10;        .where(&#10;            m.UserProject.project_id == project_id,&#10;            m.UserProject.user_id == user_id&#10;        )&#10;    )&#10;&#10;    if result.rowcount == 0:&#10;        raise HTTPException(status_code=404, detail=&quot;User not found in project&quot;)&#10;&#10;&#10;@router.post(&quot;/{project_id}/notes&quot;, status_code=201)&#10;async def get_project_notes(project_id: int, response: Response, page: int = 0, page_size: int = 100, filter_query_params=Depends(get_filter_query_params), session=Depends(session_generator)) -&gt; list[s.Note]:&#10;    &quot;&quot;&quot;Get notes associated with a project&quot;&quot;&quot;&#10;&#10;    select_stmt = select(*m.Note.__table__.columns).join(&#10;        m.UserNote, m.Note.id == m.UserNote.note_id&#10;    ).where(m.UserNote.project_id == project_id)&#10;    return await list_select_stmt(session, select_stmt, m.Note, s.Note, response, filter_query_params, page, page_size)&#10;&#10;&#10;@router.post(&quot;/{project_id}/notes&quot;, status_code=201)&#10;async def add_note_to_project(project_id: int, note: s.NoteCreate, session=Depends(session_generator)) -&gt; s.Note:&#10;    &quot;&quot;&quot;Add a note to a project&quot;&quot;&quot;&#10;&#10;    note_schema_only = s.NoteBase(**note.model_dump(exclude={'users'}))&#10;    new_note = await create_one_endpoint(session, m.Note, s.Note, note_schema_only)&#10;&#10;    # Add the mapping to the project&#10;    project_note = m.UserNote(&#10;        project_id=project_id,&#10;        note_id=new_note.id&#10;    )&#10;    session.add(project_note)&#10;&#10;    # Add the users associated with the note&#10;    for user_id in note.users:&#10;        user_note = m.UserNote(&#10;            project_id=project_id,&#10;            user_id=user_id,&#10;            note_id=new_note.id&#10;        )&#10;        session.add(user_note)&#10;&#10;    await session.refresh(new_note)&#10;&#10;    return new_note&#10;&#10;&#10;@router.delete(&quot;/{project_id}/notes/{note_id}&quot;, status_code=204)&#10;async def delete_note_from_project(project_id: int, note_id: int, session=Depends(session_generator)):&#10;    &quot;&quot;&quot;Delete a note from a project&quot;&quot;&quot;&#10;&#10;    await session.execute(&#10;        delete(m.ProjectNote)&#10;        .where(&#10;            m.ProjectNote.project_id == project_id,&#10;            m.ProjectNote.note_id == note_id&#10;        )&#10;    )&#10;&#10;&#10;@router.delete(&quot;/{project_id}/user/{user_id}&quot;, status_code=204)&#10;async def delete_user_from_project(project_id: int, user_id: int, session=Depends(session_generator)):&#10;    &quot;&quot;&quot;Delete a user from a project&quot;&quot;&quot;&#10;&#10;    # Delete the user to project mapping&#10;    await session.execute(&#10;        delete(m.UserProject)&#10;        .where(&#10;            m.UserProject.project_id == project_id,&#10;            m.UserProject.user_id == user_id&#10;        )&#10;    )&#10;&#10;    # Delete any notes associated with the user for the project&#10;    await session.execute(&#10;        delete(m.UserNote)&#10;        .where(&#10;            m.UserNote.project_id == project_id,&#10;            m.UserNote.user_id == user_id&#10;        )&#10;    )&#10;&#10;    # Delete any orphaned notes for the project (notes without any associated users)&#10;    await session.execute(&#10;        delete(m.Note)&#10;        .where(&#10;            m.Note.id.in_(&#10;                select(m.Note.id)&#10;                .join(m.UserNote, isouter=True)&#10;                .where(&#10;                    m.UserNote.project_id == project_id,&#10;                    m.UserNote.user_id == None&#10;                )&#10;            )&#10;        )&#10;    )" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>